/**
 * Build Configuration Module
 * @module config/index
 * @description
 * Core build system configuration for Plain License project.
 * Handles esbuild setup, configuration, constants.
 *
 * Features:
 * - Dynamic esbuild configuration with plugins
 * - Video and image configuration
 *
 * @see {@link https://esbuild.github.io/}
 * @see {@link https://github.com/sindresorhus/globby}
 *
 * @license Plain-Unlicense
 * @author Adam Poulemanos adam<at>plainlicense<dot>org
 * @copyright No rights reserved.
 */

import { cssModulesPlugin } from "@asn.aeb/esbuild-css-modules-plugin"
// @ts-ignore
import { tsconfigPathsPlugin } from "esbuild-plugin-tsconfig-paths"
import * as esbuild from "esbuild"
// import { copy } from 'esbuild-plugin-copy'

import type {
  HeroPaths,
  HeroVideo,
  ImageType,
  PlaceholderMap,
  Project,
  VideoCodec,
  VideoConfig,
  VideoResolution,
} from "../types.ts"

export const placeholderMap: PlaceholderMap = {
  "src/assets/stylesheets/_bundle_template.css": {
    "{{ palette-hash }}": "",
    "{{ main-hash }}": "",
  },
  "src/assets/stylesheets/_bodyfont_template.css": {
    "{{ inter-v.woff2 }}": "",
    "{{ inter-v.woff }}": "",
    "{{ bangers-regular.woff2 }}": "",
    "{{ bangers-regular.woff }}": "",
    "{{ sourcecodepro-regular.woff2 }}": "",
    "{{ sourcecodepro-regular.woff }}": "",
    "{{ raleway.woff2 }}": "",
    "{{ raleway.woff }}": "",
  },
}

export const cssLocs = {
  "src/assets/stylesheets/_bundle_template.css": {
    "{{ palette-hash }}":
      "external/mkdocs-material/material/templates/assets/stylesheets/palette.*.min.css",
    "{{ main-hash }}":
      "external/mkdocs-material/material/templates/assets/stylesheets/main.*.min.css",
  },
}

export const fontLoc = "src/assets/fonts/*"

export const videoConfig = {
  resolutions: [
    { width: 3840, height: 2160 },
    { width: 2560, height: 1440 },
    { width: 1920, height: 1080 },
    { width: 1280, height: 720 },
    { width: 854, height: 480 },
    { width: 640, height: 360 },
    { width: 426, height: 240 },
  ] as VideoResolution[],
  codecs: ["av1", "vp9", "h264"] as VideoCodec[],
  baseDir: "src/assets/videos/hero",
} as VideoConfig

export const imageTypes = ["avif", "webp", "png"] as ImageType[]
export const videoExtensions = ["webm", "mp4"]
export const videoCodecs = videoConfig.codecs

export const backupImage = "break_free"
export const cssSrc = "src/assets/stylesheets/bundle.css"
export const basePath = videoConfig.baseDir

export const resKeys: HeroPaths = Object.fromEntries(
  videoConfig.resolutions.map((res) => [res.width, ""]),
) as HeroPaths
const resolutionWidth = Object.keys(resKeys).map((key) => {
  return key.toString()
})

const heroPathsTemplate = Object.fromEntries(
  videoConfig.resolutions.map((res) => [res.width, ""]),
) as HeroPaths

export const HERO_VIDEO_TEMPLATE = {
  baseName: "",
  parent: "",
  variants: {
    av1: { ...heroPathsTemplate },
    vp9: { ...heroPathsTemplate },
    h264: { ...heroPathsTemplate },
  },
  poster: {
    parent: "",
    imageName: "",
    images: {
      avif: { widths: { ...heroPathsTemplate }, srcset: "" },
      webp: { widths: { ...heroPathsTemplate }, srcset: "" },
      png: { widths: { ...heroPathsTemplate }, srcset: "" },
    },
  },
} as HeroVideo

export const basePosterObj = HERO_VIDEO_TEMPLATE.poster

export const widthPattern = (sep: string = "|") => {
  return resolutionWidth.join(sep)
}

export const videoMessages = {
  tokyo_shuffle: "Stop the Nonsense",
  break_free: "Understanding shouldn't require a degree.",
} as Record<string, string>

const jsBanner = `/**
 * ---DO NOT EDIT THIS FILE---
 * The build process generates this file
 * You should edit the source file instead
 *
 * sources are in: src/assets/javascripts directory
 */
`
const cssBanner = `/**
  * ---DO NOT EDIT THIS FILE---
  * The build process generates this file
  * You should edit the source file instead
  *
  * sources are in: src/assets/stylesheets directory
  *
  */
`
/**
 * @description esbuild configuration for the web platform.
 */
export const webConfig: esbuild.BuildOptions = {
  bundle: true,
  minify: false,
  sourcemap: true,
  metafile: true,
  banner: { js: jsBanner, css: cssBanner },
  format: "esm",
  platform: "browser",
  target: "es2020",
  outbase: "src",
  chunkNames: "[dir]/assets/javascripts/chunks/[name].[hash]",
  assetNames: "[dir]/[name].[hash]",

  loader: {
    ".avif": "file",
    ".css": "css",
    ".js": "js",
    ".mp4": "file",
    ".png": "file",
    ".sass": "css",
    ".scss": "css",
    ".svg": "file",
    ".ts": "ts",
    ".tsx": "tsx",
    ".webm": "file",
    ".webp": "file",
    ".woff": "file",
    ".woff2": "file",
  },
  outExtension: { ".js": ".js", ".css": ".css" },
  splitting: false,
  plugins: [
    tsconfigPathsPlugin({
      cwd: process.cwd(),
      tsconfig: "tsconfig.json",
      filter: /src\/assets\/javascripts\/index.ts/,
    }),
    cssModulesPlugin({
      emitCssBundle: {
        filename: "bundle.css",
      },
    }),
    /**
     * Taking this offline for now; will revisit later
    copy({
      watch: true,
      verbose: true,
      resolveFrom: "cwd",
      globbyOptions: { gitignore: true, extglob: true, unique: true, expandDirectories: { extensions: ["svg", "woff", "woff2"]} },
      assets: [
        { from: "./src/assets/images/**", to: "./docs/assets/images" },
        { from: "./src/assets/fonts/**", to: "./docs/assets/fonts" },

      ],
    }),
      */
  ],
}

export const baseProject: Project = {
  entryPoints: [
    "src/assets/javascripts/index.ts",
    "src/assets/javascripts/workers/cache_worker.ts",
    "src/assets/stylesheets/bundle.css",
  ],
  tsconfig: "tsconfig.json",
  entryNames: "[dir]/[name].[hash]",
  platform: "browser",
  outdir: "docs",
}
